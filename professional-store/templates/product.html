{% extends "base.html" %}

{% block title %}{{ product.name }} - JUSTIN E-COMMERCE{% endblock %}

{% block content %}
<div class="product-detail-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{{ url_for('store.store') }}">Products</a>
        <span>/</span>
        <a href="{{ url_for('store.store') }}?category={{ product.category }}">{{ product.category }}</a>
        <span>/</span>
        <span>{{ product.name }}</span>
    </div>
    
    <!-- Product Detail -->
    <div class="product-detail">
        <!-- Product Image -->
        <div class="product-detail-image">
            {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
            {% else %}
            <div class="product-image-placeholder-large">üì¶</div>
            {% endif %}
            
            {% if product.featured %}
            <span class="featured-badge-large">‚≠ê Featured Product</span>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div class="product-detail-info">
            <h1 class="product-detail-title">{{ product.name }}</h1>
            <p class="product-detail-category">{{ product.category }}</p>
            
            <div class="product-detail-price">
                {{ product.get_price_formatted() }}
            </div>
            
            {% if product.is_in_stock() %}
                {% if product.stock < 10 %}
                <p class="stock-warning">‚ö†Ô∏è Only {{ product.stock }} left in stock!</p>
                {% else %}
                <p class="stock-available">‚úÖ In Stock ({{ product.stock }} available)</p>
                {% endif %}
            {% else %}
            <p class="stock-out">‚ùå Out of Stock</p>
            {% endif %}
            
            <div class="product-detail-description">
                <h3>Description</h3>
                <p>{{ product.description }}</p>
            </div>
            
            <!-- Quantity Selector -->
            {% if product.is_in_stock() %}
            <div class="quantity-selector">
                <label for="quantity">Quantity:</label>
                <div class="quantity-controls">
                    <button class="qty-btn" onclick="decreaseQty()">‚àí</button>
                    <input type="number" id="quantity" value="1" min="1" max="{{ product.stock }}" readonly>
                    <button class="qty-btn" onclick="increaseQty()">+</button>
                </div>
            </div>
            
            <!-- Add to Cart Button -->
            <div class="product-actions">
                <button class="btn-add-to-cart" onclick="addToCart()">
                    üõí Add to Cart
                </button>
                <button class="btn-buy-now" onclick="buyNow()">
                    ‚ö° Buy Now
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="related-products">
        <h2>You May Also Like</h2>
        <div class="related-products-grid">
            {% for related in related_products %}
            <div class="related-product-card">
                <a href="{{ url_for('store.product_detail', product_id=related.id) }}">
                    {% if related.image_url %}
                    <img src="{{ related.image_url }}" alt="{{ related.name }}">
                    {% else %}
                    <div class="related-image-placeholder">üì¶</div>
                    {% endif %}
                    <h4>{{ related.name }}</h4>
                    <p class="related-price">{{ related.get_price_formatted() }}</p>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    const productId = {{ product.id }};
    const maxStock = {{ product.stock }};
    
    function increaseQty() {
        const qtyInput = document.getElementById('quantity');
        let currentQty = parseInt(qtyInput.value);
        if (currentQty < maxStock) {
            qtyInput.value = currentQty + 1;
        }
    }
    
    function decreaseQty() {
        const qtyInput = document.getElementById('quantity');
        let currentQty = parseInt(qtyInput.value);
        if (currentQty > 1) {
            qtyInput.value = currentQty - 1;
        }
    }
    
    function addToCart() {
        const quantity = parseInt(document.getElementById('quantity').value);
        
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart count
                document.getElementById('cartCount').textContent = data.cart_count;
                
                // Show success notification
                showNotification(`‚úÖ Added ${quantity} item(s) to cart!`);
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('‚ùå Error adding to cart', 'error');
        });
    }
    
    function buyNow() {
        const quantity = parseInt(document.getElementById('quantity').value);
        
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to checkout
                window.location.href = '/checkout';
            } else {
                showNotification('‚ùå Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('‚ùå Error processing request', 'error');
        });
    }
    
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}